name: Build Arabic Edition

# Simplified build workflow for Arabic Edition fork
# Triggers on manual dispatch or tags on v3.6.0-arabic branch

on:
  workflow_dispatch:
    inputs:
      build_linux:
        description: 'Build Linux'
        required: false
        default: 'true'
        type: boolean
      build_macos:
        description: 'Build macOS'
        required: false
        default: 'true'
        type: boolean
      build_windows:
        description: 'Build Windows'
        required: false
        default: 'true'
        type: boolean
  push:
    tags:
      - 'v*-arabic'

defaults:
  run:
    shell: bash

env:
  NODE_VERSION: '22'

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  # Skip preflight checks for fork builds
  build-linux:
    name: 'Build (Linux)'
    runs-on: ubuntu-22.04
    if: ${{ github.event_name == 'push' || inputs.build_linux == true }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive  # Important: fetch vim plugin submodule

      - name: Setup NodeJS ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Set up build environment
        run: |
          # Enable yarn
          corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build vim plugin
        run: |
          # Build JavaScript only - skip type generation to avoid TypeScript errors
          # Type definitions aren't needed for runtime, only for development
          npx cm-buildhelper packages/codemirror-vim/src/index.ts
          node packages/codemirror-vim/scripts/addVersion.cjs

      - name: Build Linux x64 packages
        run: |
          yarn package:linux-x64
          yarn release:linux-x64

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: release/*
          if-no-files-found: warn

  build-macos:
    name: 'Build (macOS)'
    runs-on: macos-14
    if: ${{ github.event_name == 'push' || inputs.build_macos == true }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup NodeJS ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Set up build environment
        run: |
          corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build vim plugin
        run: |
          # Build JavaScript only - skip type generation to avoid TypeScript errors
          # Type definitions aren't needed for runtime, only for development
          npx cm-buildhelper packages/codemirror-vim/src/index.ts
          node packages/codemirror-vim/scripts/addVersion.cjs

      - name: Build macOS arm64 packages (with ad-hoc signing)
        run: |
          yarn package:mac-arm
          # Ad-hoc sign the app to prevent code signature crashes
          codesign --force --deep --sign - "out/Zettlr-darwin-arm64/Zettlr.app"
          yarn release:mac-arm
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false  # Disable certificate signing

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds
          path: release/*
          if-no-files-found: warn

  build-windows:
    name: 'Build (Windows)'
    runs-on: windows-2022
    if: ${{ github.event_name == 'push' || inputs.build_windows == true }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup NodeJS ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Set up build environment
        run: |
          corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build vim plugin
        run: |
          # Build JavaScript only - skip type generation to avoid TypeScript errors
          # Type definitions aren't needed for runtime, only for development
          npx cm-buildhelper packages/codemirror-vim/src/index.ts
          node packages/codemirror-vim/scripts/addVersion.cjs

      - name: Build Windows x64 packages (without code signing)
        run: |
          yarn package:win-x64
          yarn release:win-x64
        env:
          CSC_LINK: ''  # Disable certificate signing
          WIN_CSC_LINK: ''  # Disable Windows certificate signing
          SKIP_NOTARIZATION: true  # Skip notarization
          # Disable Azure Trusted Signing by not providing credentials
          # electron-builder will skip signing if these are not set

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: release/*
          if-no-files-found: warn

  create-release:
    name: 'Create or Update Release'
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-22.04
    if: ${{ startsWith(github.ref, 'refs/tags/') && !cancelled() }}
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create or Update Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          name: Zettlr Arabic Edition ${{ github.ref_name }}
          body: |
            # Zettlr Arabic Edition Release

            This is an automated build of the Zettlr Arabic Edition fork.

            ## Features
            - Complete Arabic UI translation and Arabised app icon (Ø²)
            - RTL (Right-to-Left) interface support
            - Fixed Keyboard Layout for Vim mode
            - Dual-cursor system for Arabic connected scripts

            ## Installation
            Download the appropriate package for your operating system below.

            **Note**: These builds are unsigned. You may need to allow installation from unidentified developers.
          files: ./artifacts/**/*
          fail_on_unmatched_files: true
          # This will update existing release if tag exists, or create new one
          overwrite: true
