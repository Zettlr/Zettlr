name: Audit

on:
  workflow_dispatch: {}
  push:
    paths:
      - yarn.lock
  pull_request:
    paths:
      - yarn.lock

permissions:
  contents: read

env:
  NODE_VERSION: '22'

concurrency:
  group: 'audit'
  cancel-in-progress: true

jobs:
  audit:
    name: Run audit
    runs-on: ubuntu-latest
    steps:
    # Setup
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}
    - name: Setup NodeJS ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'yarn'
    - name: Install packages
      run: yarn install --immutable
    # Run the actual audit
    - name: Audit
      # NOTE: The unholy sausage in the third line essentially uses jq to
      # condense the most important info into a human-readable txt file. This is
      # merely meant as a canary; the maintainers should absolutely run the
      # command locally once informed to get all information if necessary.
      run: |
        yarn npm audit --recursive --json > audit_result.json
        jq --slurp '.' audit_result.json > tmp.json
        mv tmp.json audit_result.json
        jq -r '.[] | .value as $v | .children += { package: $v } | .children | ("Package: \(.package)", "  Version(s) \(."Vulnerable Versions")", "  \(.Issue) (Severity: \(.Severity))", "  URL: \(.URL)")' audit_result.json > audit_result.txt
        { echo 'AUDIT_REPORT=<<EOF' echo "$(<audit_result.txt)" echo EOF } >> "$GITHUB_ENV"
    - name: Report results
      # Run this step only if yarn npm audit exited with a non-zero code.
      if: ${{ failure() }}
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_AUDIT_WEBHOOK }}
      uses: Ilshidur/action-discord@master
      with:
        args: |
          ## Repository Audit Results

          ```
          ${{ env.AUDIT_REPORT }}
          ```
    - name: Cache JSON results as artifact
      # Run this step only if yarn npm audit exited with a non-zero code.
      if: ${{ failure() }}
      uses: actions/upload-artifact@v4
      with:
        name: audit_result
        path: |
          ./audit_result.json
# 
